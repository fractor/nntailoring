'use strict';

var http = require('http')
  , Primus = require('../');

var server = http.createServer()
  , app = new Primus(server, { transformer: 'engine.io' });

app.on('connection', function (spark) {
  var messages = 0;

  spark.on('data', function () {
    messages++;
  });

  spark.on('end', function () {
    console.log('recieved %d messages', messages);
  });
});

server.listen(8080, function () {
  var socket = new app.Socket('http://localhost:8080')
    , send = 100000;

  socket.on('open', function () {
    var loop = setInterval(function () {
      if (!send--) {
        socket.end();
        return clearInterval(loop);
      }

      socket.write('message:'+ send);
    });
  });
});
